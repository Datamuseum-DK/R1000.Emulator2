#!/bin/sh

. Tests/subr_test.rc

# Patch ucode halt at 0x29f2 "ECC_EVENT_NOT_TAKEN" to <return>
cli dfs patch DIAG.M200_UCODE 0x5c240 \
	0xf8 0xf8 0xfc 0xec 0xc8 0xd8 0xc8 0xf8 \
	0xf9 0xf8 0xfd 0xe8 0xe8 0xd8 0xcc 0xf8 \
	0xc2 0x52 0x78 0x78 0x40 0x63 0x4c 0x4c \
	0x10 0x50 0x20 0x10 0x30 0x00 0x30 0x20

# Patch ucode halt at 0x29f4 "ECC_ERROR" to <return>
cli dfs patch DIAG.M200_UCODE 0x5c280 \
	0xf8 0xf8 0xfc 0xec 0xc8 0xd8 0xc8 0xf8 \
	0xf9 0xf8 0xfd 0xe8 0xe8 0xd8 0xcc 0xf8 \
	0xc2 0x52 0x78 0x78 0x40 0x63 0x4c 0x4c \
	0x10 0x50 0x20 0x10 0x30 0x00 0x30 0x20


sc_boards ioc fiu mem0 seq typ val

cli 'r1000 quota add 50'
cli 'r1000 quota exit'

cli_prompt

cli 'console << "x run_udiag"'
cli 'console match expect "long version [N] ? "'
cli 'console << "n"'
cli 'console match expect "CLI>"'

run

if ! fgrep -a 'the Confidence test (uDIAG) passed' ${R1K_PFX}/_.console ; then
	exit 2
fi
